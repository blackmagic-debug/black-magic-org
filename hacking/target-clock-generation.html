<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="../_static/favicon/icon.svg">
    <link rel="icon" sizes="16x16" type="image/png" href="../_static/favicon/favicon-16x16.png">
    <link rel="icon" sizes="32x32" type="image/png" href="../_static/favicon/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="57x57" type="image/png" href="../_static/favicon/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" type="image/png" href="../_static/favicon/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" type="image/png" href="../_static/favicon/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" type="image/png" href="../_static/favicon/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="96x96" type="image/png" href="../_static/favicon/apple-touch-icon-96x96.png">
    <link rel="apple-touch-icon" sizes="114x114" type="image/png" href="../_static/favicon/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" type="image/png" href="../_static/favicon/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" type="image/png" href="../_static/favicon/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" type="image/png" href="../_static/favicon/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" type="image/png" href="../_static/favicon/apple-touch-icon-180x180.png">
    <link rel="android-icon" sizes="192x192" type="image/png" href="../_static/favicon/android-icon-192x192.png"><meta property="og:title" content="Target Clock Generation" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://black-magic.org/hacking/target-clock-generation.html" />
<meta property="og:site_name" content="Black Magic Debug" />
<meta property="og:description" content="The Black Magic Debug firmware generates a clock signal to the debug target for both JTAG and SWD by bitbanging, timed to the other signals involved in ths bus to generate transactions and exchange..." />
<meta property="og:image" content="https://black-magic.org/_static/blackmagic-logo.png" />
<meta property="og:image:alt" content="Black Magic Debug" />
<meta name="description" content="The Black Magic Debug firmware generates a clock signal to the debug target for both JTAG and SWD by bitbanging, timed to the other signals involved in ths bus to generate transactions and exchange..." />

    <title>Target Clock Generation &#8212; Black Magic Debug  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=039e1c02" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../_static/asciinema-player_2.6.1.css" />
    <link rel="stylesheet" type="text/css" href="../_static/asciinema-custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/platformpicker.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=16ad857a"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/asciinema-player_2.6.1.js"></script>
    <script src="../_static/platformpicker.js"></script>
    <link rel="canonical" href="https://black-magic.org/hacking/target-clock-generation.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Cortex A Targets" href="target-cortex-a.html" />

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />


<link
  rel="alternate"
  type="application/atom+xml"
  href="../blog/atom.xml"
  title="Blog"
/>



  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
<section id="target-clock-generation">
<h1>Target Clock Generation<a class="headerlink" href="#target-clock-generation" title="Permalink to this heading">¶</a></h1>
<p>The Black Magic Debug firmware generates a clock signal to the debug target for both JTAG and SWD
by bitbanging, timed to the other signals involved in ths bus to generate transactions and exchange
data. The bitbanging routines are not perfect at this and so generate a signal with
an odd mark-to-space ratio and at different frequencies depending on which routine is in play.</p>
<p>Due to all of the above, this winds up requiring a very particular approach for measuring the
clock frequency generated to produce a number to report to the user, to take clock speed requests
and map them to delay loop iteration counts, internally called the <em>clock divider</em>, and then represent them
in the firmware.</p>
<p>The aim of this page is to lay out the method used to derive these clock frequency numbers and the
analytical tools used to then generate a calibration for a platform’s <code class="docutils literal notranslate"><span class="pre">platform.h</span></code> header to make the
reporting and interaction as usefully accurate as possible.</p>
<p>This method comes with a <a class="reference download internal" download="" href="../_downloads/845613343d2c4ba2701a6fe60e50733b/BMP_Frequency_Division.ods"><span class="xref download myst">LibreOffice workbook</span></a>
that acts as a tool for calculating the offset and division factors for computing <code class="docutils literal notranslate"><span class="pre">target_clk_divider</span></code>
in the firmware, which should be used to gather the measurements and verify results.</p>
<section id="measurement">
<h2>Measurement<a class="headerlink" href="#measurement" title="Permalink to this heading">¶</a></h2>
<p>In measuring TCK, because of how the bitbanging routines are written and work, it is assumed that
we are also deriving a reasonably accurate measurement for SWCLK - within 10kHz or so for a MHz range
clock speed measurement. Further, because of how the JTAG routines work, we must measure 3 key routines’
clock frequencies to come to a typical/average clock frequency, especially as these are the most common
3 routines that get called. They are, from the <code class="docutils literal notranslate"><span class="pre">jtag_proc</span></code> structure, <code class="docutils literal notranslate"><span class="pre">jtagtap_next()</span></code>, <code class="docutils literal notranslate"><span class="pre">jtagtap_tms_seq()</span></code> and
<code class="docutils literal notranslate"><span class="pre">jtagtap_tdi_tdo_seq()</span></code>.</p>
<section id="the-methodology">
<h3>The methodology<a class="headerlink" href="#the-methodology" title="Permalink to this heading">¶</a></h3>
<p>To make measurements, one will need a logic analyser capable of at least a 24MHz capture such as the
BitMagic Basic. We start out with firmware compiled for the target probe that has, by modifying the remote
protocol implementation, been forced to use the <code class="docutils literal notranslate"><span class="pre">_no_delay</span></code> bitbanging routines and a matching BMDA with
which to run JTAG scans of a suitable target. Within this section we will be using the BitMagic Basic
logic analyser and PulseView to make measurements, and have just two lines of the JTAG bus tapped - TCK and TMS.</p>
<p>TMS is used to help navigate the capture and find the correct routines to measure, TCK is of course the
signal we want to measure. We use a 1% pre-trigger capture ratio, 24MHz sampling frequency and 100 million
samples per capture to ensure we get sufficient data.</p>
<p>To prepare the first (<code class="docutils literal notranslate"><span class="pre">_no_delay</span></code>) run, we co-opt the remote protocol by <a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/799a4088e6c98fcbd977d9c3f2036bef4ba1e9b6/src/remote.c#L272">editing remote.c</a>.
We do this by commenting out the referenced line and replacing it with <code class="docutils literal notranslate"><span class="pre">target_clk_divider</span> <span class="pre">=</span> <span class="pre">UINT32_MAX;</span></code>
which, by virtue of how the bitbanging routines are written, forces the _no_delay variants.</p>
<p>We then load the firmware onto the probe, arm the logic analyser capture, and run BMDA as
<code class="docutils literal notranslate"><span class="pre">src/blackmagic</span> <span class="pre">-tjv</span> <span class="pre">1</span></code>. This will perform a JTAG scan, which prints the results and then exits.
Once complete, we can then turn our attention to PulseView where you should see a capture like the following:</p>
<p><img alt="PulseView capture of TCK generated with the _no_delay routines" src="../_images/no_delay_capture.png" /></p>
</section>
<section id="why-these-sections">
<h3>Why these sections<a class="headerlink" href="#why-these-sections" title="Permalink to this heading">¶</a></h3>
<p>The resulting capture has, as noted, two regions of interest. The reason for this is that they contain
clock pulses from all 3 major routines used and are easily identified. This is why we capture TMS as well.</p>
<p>At the start of a JTAG scan run, BMD <a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/799a4088e6c98fcbd977d9c3f2036bef4ba1e9b6/src/target/jtag_scan.c#L89-L96">reinitialises its JTAG subsystem</a>.
When it does this, it sets TMS high, sets the jtag_proc structure back up, and then <a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/799a4088e6c98fcbd977d9c3f2036bef4ba1e9b6/src/platforms/common/jtagtap.c#L53-L55">runs a &gt;50 pulse JTAG
reset and the ARM SWD-to-JTAG sequence</a>.</p>
<p>This then ensures the bus is in a good state while leaving TMS high after. We then perform an additional
JTAG reset when starting the ID code readout, along with having to switch into the Shift-DR JTAG TAP state. These
are the additional sets of pulses between the marked ones of interest. We finally do
<a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/799a4088e6c98fcbd977d9c3f2036bef4ba1e9b6/src/target/jtag_scan.c#L171">several 32-bit transactions</a>
on the bus, with the goal of reading out ID codes. These are done with TMS low giving this distinctive signature
between TMS and TCK that we see in the capture.</p>
</section>
<section id="making-the-measurements">
<h3>Making the measurements<a class="headerlink" href="#making-the-measurements" title="Permalink to this heading">¶</a></h3>
<p>We make multiple measurements in each of the following steps due to jitter caused by the capture’s
temporal resolution resulting in quantisation noise. That is, if we measure only one cycle, the value measured
may be off by a substantial enough factor that it introduces excessive error into subsequent calculations.
We counter that by making several measurements of each section of pulses, and then applying a standard average
to compensate for the capture’s jitter.</p>
<p><img alt="A detailed view of the first pulse section of interest" src="../_images/first_pulse_train.png" /></p>
<p>We start by zooming in on the first pulse section of interest, and then using measurement markers to make
several (at least 10) single-period measurements of the clock pulses generated by <code class="docutils literal notranslate"><span class="pre">jtagtap_next()</span></code>, making
notes of the results and how many of each value are observed. Add the result up and divide by the total number
of samples taken. Record the final result for later use.</p>
<p>We then repeat for <code class="docutils literal notranslate"><span class="pre">jtagtap_tms_seq()</span></code>, making a record of the final result using the same multiple measurement
and averaging method.</p>
<p><img alt="A detailed view of the second pulse section of interst" src="../_images/second_pulse_train.png" /></p>
<p>Finally, we zoom back out, pan over and then zoomed back in on the second section of interest. We then repeat
the measurement protocol on this final set of pulses and make a record of the final result after averaging.</p>
</section>
<section id="deducing-the-final-tck-clock-frequency">
<h3>Deducing the final TCK clock frequency<a class="headerlink" href="#deducing-the-final-tck-clock-frequency" title="Permalink to this heading">¶</a></h3>
<p>After following the measurement protocol outlined above, you will now have 3 values - a clock frequency achieved
by <code class="docutils literal notranslate"><span class="pre">jtagtap_next()</span></code>, <code class="docutils literal notranslate"><span class="pre">jtagtap_tms_seq()</span></code>, and <code class="docutils literal notranslate"><span class="pre">jtagtap_tdi_tdo_seq()</span></code>.</p>
<p>It is tempting to take the fastest of these and say “that’s the clock frequency!”, but this would be misleading
to the user and especially when trying to make comparative measurements to other probes and the clock frequencies
they achieve. So instead, for comparative accuracy, we must average between these 3 measurements.</p>
<p>Simply adding the 3 values up and dividing by 3 provides a reasonable approximation of the achieved clock frequency
for BMP. With this done, using the workbook referenced in the introduction, note the final value in column
A of the workbook against the delay factor line you have measured.</p>
</section>
<section id="additional-measurements">
<h3>Additional measurements<a class="headerlink" href="#additional-measurements" title="Permalink to this heading">¶</a></h3>
<p>After following this guide to get a measurement of the <code class="docutils literal notranslate"><span class="pre">_no_delay</span></code> routines, which will act as a baseline for
the highest achievable frequency output, we must then repeat with <code class="docutils literal notranslate"><span class="pre">target_clk_divider</span></code> set to the values
0 through 4 (for 5 sets of additional measurements to the <code class="docutils literal notranslate"><span class="pre">_no_delay</span></code> one).</p>
<p>These additional measurements provide the data required to perform a linear regression, and set the representation
baseline for the divider calculation.</p>
</section>
</section>
<section id="linear-regression">
<h2>Linear Regression<a class="headerlink" href="#linear-regression" title="Permalink to this heading">¶</a></h2>
<p>Having completed the measurement protocol a total of 6 times, the workbook will compute the period (in seconds) of
the clock frequencies measured, offset those against the baseline divider measurement (<code class="docutils literal notranslate"><span class="pre">target_clk_divider</span> <span class="pre">=</span> <span class="pre">0</span></code>),
and perform a linear regression on the results to generate a division factor. It will also calculate an offset
factor, in cell B12 of the sheet “Data”, which serves to determine how much the division factor must be offset to make
the calculations all work.</p>
<p>The firmware runs the linear equation <code class="docutils literal notranslate"><span class="pre">divider</span> <span class="pre">=</span> <span class="pre">(clk_divider</span> <span class="pre">+</span> <span class="pre">div_factor)</span> <span class="pre">*</span> <span class="pre">offset</span></code> and its rearrangement for
<code class="docutils literal notranslate"><span class="pre">clk_divider</span></code> to map between <code class="docutils literal notranslate"><span class="pre">target_clk_divider</span></code> and frequency values as accurately as it reasonably can.
<code class="docutils literal notranslate"><span class="pre">divider</span></code> in these equations is the value the CPU clock frequency is divided by, in order to map to the intended
TCK clock frequency.</p>
<p>It is important that the CPU frequency value in cell A9 of the sheet “Data” is accurate and is expressed in Hz.</p>
<p>The final division factor is provided as an output in cell B9 of the sheet “Data”.</p>
</section>
<section id="writing-the-calibration-for-the-platform">
<h2>Writing the calibration for the platform<a class="headerlink" href="#writing-the-calibration-for-the-platform" title="Permalink to this heading">¶</a></h2>
<p>Having done all of the above, there are a series of simple <code class="docutils literal notranslate"><span class="pre">#define</span></code> statements that must be added to the platform’s header. We will make reference to the native (BMP) platform as an example for this section.</p>
<p>The first thing that must be defined in the platform header, is <a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/799a4088e6c98fcbd977d9c3f2036bef4ba1e9b6/src/platforms/native/platform.h#L296"><code class="docutils literal notranslate"><span class="pre">BITBANG_CALIBRATED_FREQS</span></code></a>
which serves to inform the <code class="docutils literal notranslate"><span class="pre">platform_max_frequency_{get,set}</span></code> implementations that a calibration has been done and
not to use the old method this replaces.</p>
<p>With this defined, we must then define the frequency achieved by the <code class="docutils literal notranslate"><span class="pre">_no_delay</span></code> routines, and the maximum frequency
achieved by  the <code class="docutils literal notranslate"><span class="pre">_clk_delay</span></code> routines. This involves defining <a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/799a4088e6c98fcbd977d9c3f2036bef4ba1e9b6/src/platforms/native/platform.h#L305-L313C9"><code class="docutils literal notranslate"><span class="pre">BITBANG_NO_DELAY_FREQ</span></code> and <code class="docutils literal notranslate"><span class="pre">BITBANG_0_DELAY_FREQ</span></code></a>
which are the measured frequency values expressed in Hz.</p>
<p>Finally, the conversion constants for the delay routines must be defined. These are
<a class="reference external" href="https://github.com/blackmagic-debug/blackmagic/blob/799a4088e6c98fcbd977d9c3f2036bef4ba1e9b6/src/platforms/native/platform.h#L327-L328"><code class="docutils literal notranslate"><span class="pre">BITBANG_DIVIDER_OFFSET</span></code> and <code class="docutils literal notranslate"><span class="pre">BITBANG_DIVIDER_FACTOR</span></code></a>.
These are the values from the linear regression called out in the above section -
workbook sheet “Data”, cells B9 and B12.</p>
</section>
</section>

<div class="section ablog__blog_comments">
  
  
</div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/blackmagic-logo.svg" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">The Plug&Play MCU Debugger</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=blackmagic-debug&repo=blackmagic&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Intro</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hardware.html">Supported Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrade.html">Firmware Upgrade</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Knowledgebase</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../knowledge/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../knowledge/terminology.html">Terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../knowledge/pinouts.html">Pinout Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../knowledge/links.html">Links</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usage/gdb-commands.html">GDB Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/gdb-automation.html">GDB Flash Automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/semihosting.html">Semihosting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/traceswo.html">SWD - TRACESWO support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/swo.html">Serial Wire Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/rtt.html">Using RTT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/platformio.html">PlatformIO</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Target Specific Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../target-usage/stm32.html">STM32 Targets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target-usage/sam3x-4x-x7x.html">SAM3x-4x-x7x</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hacking</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="contrib.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="hacking.html">Firmware Hacking</a></li>
<li class="toctree-l1"><a class="reference internal" href="target-drivers.html">Adding Target Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="target-cortex-m.html">Cortex-M Targets</a></li>
<li class="toctree-l1"><a class="reference internal" href="target-cortex-a.html">Cortex A Targets</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Target Clock Generation</a></li>
</ul>


<div class="ablog-sidebar-item ablog__recentposts">
<h3>
  <a href="../blog.html">Recent Posts</a>
</h3>
<ul>
  
  
  <li>
    <a href="../blog/2022-07-21-release-v1_8_2.html">
      21 July - Stable Release V1.8.2
    </a>
  </li>
  
  <li>
    <a href="../blog/2022-07-13-release-v1_8_1.html">
      13 July - Stable Release V1.8.1
    </a>
  </li>
  
  <li>
    <a href="../blog/2022-05-30-release-v1_8_0.html">
      30 May - Stable Release V1.8.0
    </a>
  </li>
  
  <li>
    <a href="../blog/2022-01-20-organization-rename.html">
      20 January - GitHub Organization Name Change
    </a>
  </li>
  
  <li>
    <a href="../blog/2022-01-07-new-maintainer.html">
      07 January - New Project Maintainer
    </a>
  </li>
  
</ul>
</div>

<div class="ablog-sidebar-item ablog__archive">
<h3>
  <a href="../blog/archive.html">Archives</a>
</h3>
<ul>
  
  
  <li>
    <a href="../blog/2022.html">2022 (5)</a>
  </li>
  
  
</ul>
</div>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="target-cortex-a.html" title="previous chapter">Cortex A Targets</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022-2023, Piotr Esden-Tempski <piotr@esden.net>; 2022-2023, Rachel Mant <git@dragonmux.network>.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>